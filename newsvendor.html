<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ¥ç«¥å†³ç­–å®éªŒ (AIå¢å¼ºç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background-color: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #2c3e50; }
        .hidden { display: none !important; }
        
        /* å¸ƒå±€ */
        .game-layout { display: flex; gap: 20px; }
        @media (max-width: 768px) { .game-layout { flex-direction: column-reverse; } }
        
        .sidebar { flex: 1; background: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid #e9ecef; max-height: 600px; overflow-y: auto;}
        .main-area { flex: 2; padding: 10px; }

        /* å‚æ•°é¢æ¿ */
        .params-box { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #2196f3; }
        .params-box p { margin: 5px 0; font-weight: bold; }
        
        /* æ•°æ®åˆ—è¡¨ */
        .history-list { list-style: none; padding: 0; font-size: 14px; color: #666; max-height: 300px; overflow-y: auto; }
        .history-list li { padding: 6px 0; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; }
        .sold-out { color: red; font-weight: bold; font-size: 12px; background: #ffe6e6; padding: 2px 4px; border-radius: 4px; }

        /* æ ¸å¿ƒæ“ä½œåŒº */
        .round-info { font-size: 24px; font-weight: bold; color: #d35400; margin-bottom: 20px; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        input[type=number] { padding: 12px; width: 100%; border: 2px solid #ddd; border-radius: 8px; font-size: 18px; box-sizing: border-box; margin: 10px 0; }
        
        /* æŒ‰é’® */
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; transition: 0.2s; margin-bottom: 15px; }
        .btn-start { background: #27ae60; color: white; margin-top: 20px; font-size: 20px; padding: 15px 40px; }
        .btn-ai { background: #8e44ad; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-submit { background: #c0392b; color: white; font-size: 18px; padding: 15px; margin-top: 10px; }
        .btn-next { background: #2980b9; color: white; margin-top: 20px; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; opacity: 1; }

        .ai-box { background: #fffdf5; border: 2px dashed #f39c12; padding: 15px; border-radius: 8px; margin-bottom: 20px; min-height: 60px; font-size: 15px; line-height: 1.6; }
        .feedback-panel { background: #d4edda; border: 2px solid #28a745; padding: 25px; border-radius: 10px; text-align: center; }
        .profit-show { font-size: 32px; color: #28a745; font-weight: bold; margin: 20px 0; }
        .data-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #c3e6cb; padding-bottom: 5px; }
        .loading { color: #f39c12; font-weight: bold; display: flex; align-items: center; gap: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“° æŠ¥ç«¥å†³ç­–å®éªŒ (AI ååŒç‰ˆ)</h1>

    <div id="setup-screen" style="text-align:center; padding: 50px 20px;">
        <div style="background: #f8f9fa; padding: 30px; border-radius: 15px; display:inline-block; text-align:left; max-width: 600px;">
            <h2 style="margin-top:0;">ğŸ“ å®éªŒè¯´æ˜</h2>
            <p>æ¬¢è¿å‚åŠ ã€‚ç³»ç»Ÿå·²è‡ªåŠ¨ä¸ºæ‚¨åˆ†é…ä»£å·ï¼š<strong id="auto-id-display" style="color:#2196f3;">...</strong></p>
            <ul style="line-height: 1.8;">
                <li><strong>äº§å“å”®ä»· 12 å…ƒï¼Œæˆæœ¬ 3 å…ƒï¼Œæ®‹å€¼ 0 å…ƒã€‚</strong></li>
                <li>ä½ éœ€è¦è¿›è¡Œ 5 è½®å†³ç­–ã€‚</li>
                <li>æ³¨æ„ï¼šè‹¥å‘ç”Ÿç¼ºè´§ï¼Œä½ åªèƒ½çœ‹åˆ°äº§å“å–å…‰äº†ï¼Œæ— æ³•å¾—çŸ¥çœŸå®éœ€æ±‚ã€‚</li>
            </ul>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-start" onclick="initGame()">ğŸš€ å¼€å§‹å®éªŒ</button>
            </div>
            <p id="init-error" style="color:red; font-size:14px; text-align:center;"></p>
        </div>
    </div>

    <div id="game-screen" class="hidden game-layout">
        <div class="sidebar">
            <div class="params-box">
                <p>ğŸ’° å”®ä»· (p): 12 å…ƒ</p>
                <p>ğŸ“‰ æˆæœ¬ (c): 3 å…ƒ</p>
                <p>â™»ï¸ æ®‹å€¼ (s): 0 å…ƒ</p>
            </div>
            <h3>ğŸ“œ å†å²é”€å”®è®°å½•</h3>
            <div style="font-size:12px; color:#888; margin-bottom:10px;">* çº¢è‰²æ ‡è®°è¡¨ç¤ºå½“æœŸå”®ç½„(ç¼ºè´§)</div>
            <ul id="history-list" class="history-list"></ul>
        </div>

        <div class="main-area">
            <div class="round-info">å½“å‰è½®æ¬¡ï¼š<span id="current-round-span" style="font-size:32px;">1</span> / 5</div>

            <button id="btn-pre-ai" class="btn btn-ai" onclick="getPreAdvice()">ğŸ§  ç‚¹å‡»å’¨è¯¢ DeepSeek è®¢è´§å»ºè®®</button>
            <div id="pre-ai-box" class="ai-box hidden"></div>

            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; border: 1px solid #ddd;">
                <label style="font-weight:bold; font-size:18px; display:block; margin-bottom:10px;">è¯·åšå‡ºæœ¬è½®å†³ç­–ï¼š</label>
                <input type="number" id="order-quantity" placeholder="è¯·è¾“å…¥è®¢è´§é‡ (å»ºè®®èŒƒå›´ 0-300)">
                <button id="btn-submit" class="btn btn-submit" onclick="submitDecision()">âœ… ç¡®è®¤è®¢è´§å¹¶æäº¤</button>
            </div>
        </div>
    </div>

    <div id="feedback-screen" class="hidden">
        <div class="feedback-panel">
            <h2>ğŸ“Š ç¬¬ <span id="fb-round-num"></span> è½®ç»“æœ</h2>
            <div style="text-align: left; margin: 20px 0;">
                <div class="data-row"><span>ğŸ“¦ ä½ çš„è®¢è´§é‡ï¼š</span><strong id="fb-order"></strong></div>
                <div class="data-row"><span>ğŸ›ï¸ çœŸå®å¸‚åœºéœ€æ±‚ï¼š</span><strong id="fb-demand" style="color:#c0392b;"></strong></div>
                <div class="data-row"><span>ğŸ¤ å®é™…é”€å”®é‡ï¼š</span><strong id="fb-sales"></strong></div>
            </div>
            <div class="profit-show">æœ¬è½®æ”¶ç›Šï¼š<span id="fb-profit"></span> å…ƒ</div>
        </div>
        
        <div style="margin-top: 20px;">
            <h3>ğŸ¤– AI èµ›åå¤ç›˜ï¼š</h3>
            <div id="post-ai-box" class="ai-box"><span class="loading">â³ DeepSeek æ­£åœ¨åˆ†æä½ çš„å†³ç­–...</span></div>
        </div>

        <button class="btn btn-next" onclick="nextRound()">è¿›å…¥ä¸‹ä¸€è½® â¡</button>
    </div>

    <div id="final-screen" class="hidden" style="text-align: center; padding-top: 50px;">
        <h1 style="color:#28a745;">ğŸ‰ å®éªŒå®Œæˆï¼</h1>
        <p style="font-size: 24px; margin-top: 20px;">ä½ çš„ 5 è½®æ€»æ”¶ç›Šä¸ºï¼š</p>
        <div style="font-size: 60px; color: #d35400; font-weight: bold; margin: 20px 0;"><span id="total-profit-span"></span> å…ƒ</div>
        <button class="btn btn-start" onclick="location.reload()">ğŸ”„ å†æ¥ä¸€æ¬¡</button>
    </div>

</div>

<script>
    // ================= é…ç½®åŒº =================
    const supabaseUrl = 'https://adjvfvfbjfrtenvbocfw.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkanZmdmZiamZydGVudmJvY2Z3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMzAzNjEsImV4cCI6MjA4MTcwNjM2MX0.Fzd2LU2ueKg0V47NSC9nQY_5hHaFY8SqJuV281iXKag';
    const deepSeekKey = 'sk-d5897c92a0134bf8b6d36ee19d30e782';
    // ==========================================

    // è‡ªåŠ¨ç”Ÿæˆä»£å·
    const autoId = 'User_' + Math.floor(Math.random() * 9000 + 1000);
    document.getElementById('auto-id-display').innerText = autoId;

    // å…¨å±€çŠ¶æ€
    const gameState = {
        participantId: autoId,
        currentRound: 0,
        maxRounds: 5,
        totalProfit: 0,
        historyData: [],
        currentOrder: 0,
        currentTrueDemand: 0,
        currentSales: 0,
        currentProfit: 0,
        preAiAdvice: '',
        postAiAdvice: ''
    };

    // --- æ ¸å¿ƒå‡½æ•°1ï¼šåˆå§‹åŒ–æ¸¸æˆ ---
    function initGame() {
        // 1. æ£€æŸ¥ Supabase åº“æ˜¯å¦åŠ è½½
        if (typeof window.supabase === 'undefined') {
            const err = "âŒ é”™è¯¯ï¼šSupabase åº“æœªåŠ è½½ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œåŸå› ï¼‰ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚";
            document.getElementById('init-error').innerText = err;
            alert(err);
            return;
        }

        // 2. ç”Ÿæˆ 40 æœŸå†å²æ•°æ® (åˆ å¤±é€»è¾‘)
        gameState.historyData = [];
        const historicalOrderCap = 180; 
        for (let i = 0; i < 40; i++) {
            const trueD = Math.floor(Math.random() * 301);
            // åˆ å¤±ï¼šåªèƒ½çœ‹åˆ° min(trueD, 180)
            const sales = Math.min(trueD, historicalOrderCap);
            gameState.historyData.push({
                sales: sales,
                stockout: trueD > historicalOrderCap
            });
        }

        updateHistoryView();
        gameState.currentRound = 1;
        updateRoundDisplay();
        switchScreen('game-screen');
    }

    // --- æ ¸å¿ƒå‡½æ•°2ï¼šè·å– AI å»ºè®® ---
    async function getPreAdvice() {
        if (typeof marked === 'undefined') { alert("Markdown åº“æœªåŠ è½½"); return; }
        
        const btn = document.getElementById('btn-pre-ai');
        const aiBox = document.getElementById('pre-ai-box');
        
        aiBox.classList.remove('hidden');
        aiBox.innerHTML = '<span class="loading">â³ DeepSeek æ­£åœ¨åˆ†æ...</span>';
        btn.disabled = true;

        const recentHistory = gameState.historyData.slice(-20).map((h, i) => 
            `T-${20-i}:${h.sales}${h.stockout ? "(ç¼ºè´§)" : ""}`
        ).join(", ");

        const prompt = `ä½ æ˜¯ä¸€ä¸ªä¾›åº”é“¾ç®¡ç†ä¸“å®¶ã€‚æŠ¥ç«¥å†³ç­–å®éªŒï¼šå”®ä»·p=12ï¼Œæˆæœ¬c=3ï¼Œæ®‹å€¼s=0ã€‚
æœ€è¿‘20æœŸé”€å”®è®°å½•ï¼ˆå­˜åœ¨æ•°æ®åˆ å¤±ï¼Œ(ç¼ºè´§)ä»£è¡¨çœŸå®éœ€æ±‚å¯èƒ½æ›´é«˜ï¼‰ï¼š[${recentHistory}]ã€‚
è¯·åˆ†æçœŸå®éœ€æ±‚åˆ†å¸ƒå¯èƒ½çš„æƒ…å†µï¼Œå¹¶ç»™å‡ºä¸€å¥ç®€çŸ­çš„è®¢è´§é‡å»ºè®®ï¼ˆå…·ä½“æ•°å­—ï¼‰ã€‚å­—æ•°100å­—ä»¥å†…ã€‚`;

        const reply = await callDeepSeek(prompt);
        aiBox.innerHTML = marked.parse(reply);
        gameState.preAiAdvice = reply;
        btn.disabled = false;
        btn.innerText = "ğŸ”„ é‡æ–°å’¨è¯¢";
    }

    // --- æ ¸å¿ƒå‡½æ•°3ï¼šæäº¤å†³ç­– ---
    async function submitDecision() {
        const orderInput = document.getElementById('order-quantity');
        const Q = parseInt(orderInput.value);
        if (isNaN(Q) || Q < 0) { alert("è¯·è¾“å…¥æœ‰æ•ˆçš„è®¢è´§é‡ï¼"); return; }
        
        const submitBtn = document.getElementById('btn-submit');
        submitBtn.disabled = true;
        submitBtn.innerText = "â³ ç»“ç®—ä¸­...";

        // ç»“ç®—
        gameState.currentOrder = Q;
        gameState.currentTrueDemand = Math.floor(Math.random() * 301);
        gameState.currentSales = Math.min(Q, gameState.currentTrueDemand);
        gameState.currentProfit = (12 * gameState.currentSales) - (3 * Q);
        gameState.totalProfit += gameState.currentProfit;

        // æ›´æ–°ç•Œé¢
        document.getElementById('fb-round-num').innerText = gameState.currentRound;
        document.getElementById('fb-order').innerText = Q;
        document.getElementById('fb-demand').innerText = gameState.currentTrueDemand;
        document.getElementById('fb-sales').innerText = gameState.currentSales;
        const profitSpan = document.getElementById('fb-profit');
        profitSpan.innerText = gameState.currentProfit;
        profitSpan.style.color = gameState.currentProfit >= 0 ? "#28a745" : "#c0392b";

        switchScreen('feedback-screen');

        // å¹¶è¡Œï¼šAI å¤ç›˜ + å­˜æ•°æ®åº“
        await getPostFeedback();
        saveRoundData(); // ä¸awaitï¼Œåå°å­˜å³å¯

        document.querySelector('.btn-next').disabled = false;
    }

    // --- æ ¸å¿ƒå‡½æ•°4ï¼šèµ›åå¤ç›˜ ---
    async function getPostFeedback() {
        const aiBox = document.getElementById('post-ai-box');
        const prompt = `å›é¡¾è¿™è½®æŠ¥ç«¥å†³ç­–ã€‚å‚æ•° p=12, c=3ã€‚
è¢«è¯•è®¢è´§é‡ Q=${gameState.currentOrder}ã€‚çœŸå®éšæœºéœ€æ±‚ D=${gameState.currentTrueDemand}ã€‚æœ¬è½®åˆ©æ¶¦=${gameState.currentProfit}ã€‚
è¯·ç®€çŸ­ç‚¹è¯„è¿™æ¬¡å†³ç­–ï¼ˆè¿‡äºä¿å®ˆè¿˜æ˜¯æ¿€è¿›ï¼Ÿï¼‰ï¼Œå¹¶é¼“åŠ±è¢«è¯•ã€‚80å­—ä»¥å†…ã€‚`;
        const reply = await callDeepSeek(prompt);
        aiBox.innerHTML = marked.parse(reply);
        gameState.postAiAdvice = reply;
    }

    // --- æ ¸å¿ƒå‡½æ•°5ï¼šå­˜æ•°æ® ---
    async function saveRoundData() {
        // åŠ¨æ€åˆ›å»º Client é˜²æ­¢åˆå§‹åŒ–æŠ¥é”™
        if (typeof window.supabase === 'undefined') return;
        const client = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        const { error } = await client.from('newsvendor_rounds').insert([{
            participant_id: gameState.participantId,
            round_num: gameState.currentRound,
            order_q: gameState.currentOrder,
            true_demand: gameState.currentTrueDemand,
            sales: gameState.currentSales,
            profit: gameState.currentProfit,
            ai_pre_advice: gameState.preAiAdvice,
            ai_post_feedback: gameState.postAiAdvice
        }]);
        if (error) console.error("Supabase Error:", error);
    }

    // --- æ ¸å¿ƒå‡½æ•°6ï¼šä¸‹ä¸€è½® ---
    function nextRound() {
        gameState.historyData.push({
            sales: gameState.currentSales,
            stockout: gameState.currentTrueDemand > gameState.currentOrder
        });

        if (gameState.currentRound >= gameState.maxRounds) {
            document.getElementById('total-profit-span').innerText = gameState.totalProfit;
            switchScreen('final-screen');
        } else {
            gameState.currentRound++;
            updateHistoryView();
            updateRoundDisplay();
            
            // é‡ç½® UI
            document.getElementById('order-quantity').value = '';
            document.getElementById('pre-ai-box').classList.add('hidden');
            document.getElementById('btn-pre-ai').disabled = false;
            document.getElementById('btn-pre-ai').innerText = "ğŸ§  ç‚¹å‡»å’¨è¯¢ DeepSeek è®¢è´§å»ºè®®";
            document.getElementById('btn-submit').disabled = false;
            document.getElementById('btn-submit').innerText = "âœ… ç¡®è®¤è®¢è´§å¹¶æäº¤";
            document.getElementById('post-ai-box').innerHTML = '<span class="loading">â³ DeepSeek æ­£åœ¨åˆ†æ...</span>';
            document.querySelector('.btn-next').disabled = true;
            gameState.preAiAdvice = "";
            gameState.postAiAdvice = "";
            
            switchScreen('game-screen');
        }
    }

    // --- API è°ƒç”¨ ---
    async function callDeepSeek(promptText) {
        try {
            const response = await fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + deepSeekKey },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{"role": "user", "content": promptText}],
                    temperature: 1.1
                })
            });
            const data = await response.json();
            return data.choices && data.choices.length > 0 ? data.choices[0].message.content : "AI æš‚æ—¶æ— å“åº”";
        } catch (e) { console.error(e); return "AI è¿æ¥å¤±è´¥"; }
    }

    // è¾…åŠ©å‡½æ•°
    function updateHistoryView() {
        const list = document.getElementById('history-list');
        list.innerHTML = ''; 
        const recentData = gameState.historyData.slice().reverse().slice(0, 40);
        recentData.forEach((item, index) => {
            const li = document.createElement('li');
            const label = (gameState.historyData.length - index) <= 40 ? "å†å²" : "å®éªŒ";
            li.innerHTML = `<span>[${label}] é”€é‡: <strong>${item.sales}</strong></span> ${item.stockout ? '<span class="sold-out">å”®ç½„</span>' : ''}`;
            list.appendChild(li);
        });
    }

    function updateRoundDisplay() { document.getElementById('current-round-span').innerText = gameState.currentRound; }
    function switchScreen(id) {
        ['setup-screen', 'game-screen', 'feedback-screen', 'final-screen'].forEach(sid => document.getElementById(sid).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
</script>
</body>
</html>