<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ¥ç«¥å†³ç­–å®éªŒ (æ•°æ®åˆ å¤±ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background-color: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #2c3e50; }
        .hidden { display: none !important; }
        
        /* å¸ƒå±€ */
        .game-layout { display: flex; gap: 20px; }
        @media (max-width: 768px) { .game-layout { flex-direction: column-reverse; } }
        
        .sidebar { flex: 1; background: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid #e9ecef; max-height: 600px; overflow-y: auto;}
        .main-area { flex: 2; padding: 10px; }

        .params-box { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #2196f3; }
        .params-box p { margin: 5px 0; font-weight: bold; }
        
        .history-list { list-style: none; padding: 0; font-size: 14px; color: #666; max-height: 300px; overflow-y: auto; }
        .history-list li { padding: 8px 0; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; align-items: center; }
        
        .sold-out { 
            color: #c0392b; 
            font-weight: bold; 
            font-size: 12px; 
            background: #fadbd8; 
            padding: 2px 6px; 
            border-radius: 4px; 
            border: 1px solid #e6b0aa;
        }

        .round-info { font-size: 24px; font-weight: bold; color: #d35400; margin-bottom: 20px; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        input[type=number] { padding: 12px; width: 100%; border: 2px solid #ddd; border-radius: 8px; font-size: 18px; box-sizing: border-box; margin: 10px 0; }
        
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; transition: 0.2s; margin-bottom: 15px; }
        .btn-start { background: #27ae60; color: white; margin-top: 20px; font-size: 20px; padding: 15px 40px; }
        .btn-ai { background: #8e44ad; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-submit { background: #c0392b; color: white; font-size: 18px; padding: 15px; margin-top: 10px; }
        .btn-next { background: #2980b9; color: white; margin-top: 20px; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; opacity: 1; }

        .ai-box { background: #fffdf5; border: 2px dashed #f39c12; padding: 15px; border-radius: 8px; margin-bottom: 20px; min-height: 60px; font-size: 15px; line-height: 1.6; }
        .loading { color: #f39c12; font-weight: bold; display: flex; align-items: center; gap: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“° æŠ¥ç«¥å†³ç­–å®éªŒ (AI ååŒç‰ˆ)</h1>

    <div id="setup-screen" style="text-align:center; padding: 50px 20px;">
        <div style="background: #f8f9fa; padding: 30px; border-radius: 15px; display:inline-block; text-align:left; max-width: 600px;">
            <h2 style="margin-top:0;">ğŸ“ å®éªŒè¯´æ˜</h2>
            <p>æ¬¢è¿å‚åŠ ã€‚ç³»ç»Ÿå·²è‡ªåŠ¨ä¸ºæ‚¨åˆ†é…ä»£å·ï¼š<strong id="auto-id-display" style="color:#2196f3;">...</strong></p>
            <ul style="line-height: 1.8;">
                <li><strong>äº§å“å”®ä»· 12 å…ƒï¼Œæˆæœ¬ 3 å…ƒï¼Œæ®‹å€¼ 0 å…ƒã€‚</strong></li>
                <li>ä½ éœ€è¦è¿›è¡Œ 5 è½®å†³ç­–ã€‚</li>
                <li><strong>æ³¨æ„æ•°æ®åˆ å¤±ï¼š</strong><br>å¦‚æœè®¢è´§é‡ä¸è¶³å¯¼è‡´<strong>å”®ç½„</strong>ï¼Œä½ å°†<strong>æ— æ³•å¾—çŸ¥</strong>å½“æœŸçš„çœŸå®éœ€æ±‚æ˜¯å¤šå°‘ã€‚</li>
            </ul>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-start" onclick="initGame()">ğŸš€ å¼€å§‹å®éªŒ</button>
            </div>
        </div>
    </div>

    <div id="game-screen" class="hidden game-layout">
        <div class="sidebar">
            <div class="params-box">
                <p>ğŸ’° å”®ä»· (p): 12</p>
                <p>ğŸ“‰ æˆæœ¬ (c): 3</p>
                <p>ğŸ“Š å…³é”®æ¯”ç‡ (CR): 75%</p>
            </div>
            <h3>ğŸ“œ å†å²é”€å”®è®°å½•</h3>
            <div style="font-size:12px; color:#888; margin-bottom:10px;">* åˆ—è¡¨å®æ—¶æ›´æ–°ï¼Œæœ€æ–°æ•°æ®åœ¨æœ€ä¸Šæ–¹</div>
            <ul id="history-list" class="history-list"></ul>
        </div>

        <div class="main-area">
            <div class="round-info">å½“å‰è½®æ¬¡ï¼š<span id="current-round-span" style="font-size:32px;">1</span> / 5</div>

            <button id="btn-pre-ai" class="btn btn-ai" onclick="getPreAdvice()">ğŸ§  å¯åŠ¨ç®—æ³•åˆ†æä¸ AI å»ºè®®</button>
            <div id="pre-ai-box" class="ai-box hidden"></div>

            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; border: 1px solid #ddd;">
                <label style="font-weight:bold; font-size:18px; display:block; margin-bottom:10px;">è¯·åšå‡ºæœ¬è½®å†³ç­–ï¼š</label>
                <input type="number" id="order-quantity" placeholder="è¯·è¾“å…¥è®¢è´§é‡">
                <button id="btn-submit" class="btn btn-submit" onclick="submitDecision()">âœ… ç¡®è®¤è®¢è´§å¹¶æäº¤</button>
            </div>
        </div>
    </div>

    <div id="feedback-screen" class="hidden">
        <div style="background: #d4edda; border: 2px solid #28a745; padding: 25px; border-radius: 10px; text-align: center;">
            <h2>ğŸ“Š ç¬¬ <span id="fb-round-num"></span> è½®ç»“æœ</h2>
            <div style="text-align:left; margin: 20px auto; max-width: 400px; line-height: 2;">
                <div>ğŸ“¦ ä½ çš„è®¢è´§é‡ï¼š<strong id="fb-order"></strong></div>
                <div>ğŸ›ï¸ çœŸå®å¸‚åœºéœ€æ±‚ï¼š<strong id="fb-demand"></strong></div>
                <div>ğŸ¤ å®é™…é”€å”®é‡ï¼š<strong id="fb-sales"></strong></div>
            </div>
            <div style="font-size: 32px; color: #28a745; font-weight: bold; margin: 20px 0;">æœ¬è½®æ”¶ç›Šï¼š<span id="fb-profit"></span> å…ƒ</div>
            <p style="font-size:14px; color:#555;">(è¯¥æ•°æ®å·²æ›´æ–°è‡³å·¦ä¾§å†å²åˆ—è¡¨)</p>
        </div>
        
        <div style="margin-top: 20px;">
            <h3>ğŸ¤– AI èµ›åå¤ç›˜ï¼š</h3>
            <div id="post-ai-box" class="ai-box"><span class="loading">â³ DeepSeek æ­£åœ¨å¤ç›˜...</span></div>
        </div>

        <button class="btn btn-next" onclick="nextRound()">è¿›å…¥ä¸‹ä¸€è½® â¡</button>
    </div>

    <div id="final-screen" class="hidden" style="text-align: center; padding-top: 50px;">
        <h1 style="color:#28a745;">ğŸ‰ å®éªŒå®Œæˆï¼</h1>
        <div style="font-size: 60px; color: #d35400; font-weight: bold; margin: 20px 0;"><span id="total-profit-span"></span> å…ƒ</div>
        <button class="btn btn-start" onclick="location.reload()">ğŸ”„ å†æ¥ä¸€æ¬¡</button>
    </div>

</div>

<script>
    // ================= é…ç½®åŒº =================
    const supabaseUrl = 'https://adjvfvfbjfrtenvbocfw.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkanZmdmZiamZydGVudmJvY2Z3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMzAzNjEsImV4cCI6MjA4MTcwNjM2MX0.Fzd2LU2ueKg0V47NSC9nQY_5hHaFY8SqJuV281iXKag';
    const deepSeekKey = 'sk-d5897c92a0134bf8b6d36ee19d30e782';
    // ==========================================

    const autoId = 'User_' + Math.floor(Math.random() * 9000 + 1000);
    document.getElementById('auto-id-display').innerText = autoId;

    const gameState = {
        participantId: autoId,
        currentRound: 0,
        maxRounds: 5,
        totalProfit: 0,
        historyData: [],
        currentOrder: 0,
        currentTrueDemand: 0,
        currentSales: 0,
        currentProfit: 0,
        currentStockout: false, // æ–°å¢ï¼šè®°å½•æœ¬è½®æ˜¯å¦ç¼ºè´§
        preAiAdvice: '',
        postAiAdvice: ''
    };

    function initGame() {
        if (typeof window.supabase === 'undefined') { alert("Supabase åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°"); return; }
        
        // ç”Ÿæˆ 40 æœŸå†å²æ•°æ®
        gameState.historyData = [];
        const historicalOrderCap = 180; 
        for (let i = 0; i < 40; i++) {
            const trueD = Math.floor(Math.random() * 301);
            const sales = Math.min(trueD, historicalOrderCap);
            gameState.historyData.push({ sales: sales, stockout: trueD > historicalOrderCap });
        }

        updateHistoryView();
        gameState.currentRound = 1;
        updateRoundDisplay();
        switchScreen('game-screen');
    }

    function calculateAlgoRecommendation() {
        const history = gameState.historyData;
        const n = history.length;
        if (n === 0) return { mean: 0, stockoutRate: 0, recommendQ: 0 };

        let totalSales = 0;
        let stockoutCount = 0;
        history.forEach(h => {
            totalSales += h.sales;
            if (h.stockout) stockoutCount++;
        });
        
        let obsMean = totalSales / n; 
        let stockoutRate = (stockoutCount / n) * 100;

        let sumSqDiff = 0;
        history.forEach(h => { sumSqDiff += Math.pow(h.sales - obsMean, 2); });
        let obsStd = Math.sqrt(sumSqDiff / n);

        let adjustedTotal = 0;
        history.forEach(h => {
            adjustedTotal += h.stockout ? (h.sales + obsStd) : h.sales;
        });
        let adjMean = adjustedTotal / n;

        const algoQ = Math.round(adjMean + 0.675 * (obsStd * 1.1));

        return {
            mean: Math.round(obsMean),
            adjMean: Math.round(adjMean),
            stockoutRate: stockoutRate.toFixed(1),
            recommendQ: algoQ
        };
    }

    async function getPreAdvice() {
        if (typeof marked === 'undefined') { alert("Markdown åº“æœªåŠ è½½"); return; }
        
        const btn = document.getElementById('btn-pre-ai');
        const aiBox = document.getElementById('pre-ai-box');
        
        aiBox.classList.remove('hidden');
        aiBox.innerHTML = '<span class="loading">â³ ç®—æ³•æ‹Ÿåˆä¸­...</span>';
        btn.disabled = true;

        const stats = calculateAlgoRecommendation();

        const prompt = `ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½å†³ç­–ç³»ç»Ÿã€‚p=12, c=3, CR=0.75ã€‚
ç®—æ³•åˆ†æï¼šå†å²ç¼ºè´§ç‡ ${stats.stockoutRate}%ï¼Œä¿®æ­£å‡å€¼ ${stats.adjMean}ã€‚
ç®—æ³•æ¨èè®¢è´§é‡: ${stats.recommendQ}ã€‚
è¯·åŸºäºç®—æ³•ç»“æœç»™å†³ç­–è€…å»ºè®®ã€‚è§£é‡Šæ¨èç†ç”±ã€‚100å­—ä»¥å†…ã€‚`;

        const reply = await callDeepSeek(prompt);
        
        const finalHtml = `
            <div style="background:#e3f2fd; padding:10px; border-radius:5px; margin-bottom:10px; font-size:14px;">
                <strong>ğŸ“Š ç®—æ³•è®¡ç®—ç»“æœï¼š</strong><br>
                ä¿®æ­£åé¢„ä¼°å‡å€¼: ${stats.adjMean} | ç¼ºè´§ç‡: ${stats.stockoutRate}%<br>
                <span style="color:#d35400;">â­ ç®—æ³•æ¨èå€¼: ${stats.recommendQ}</span>
            </div>
            ${marked.parse(reply)}
        `;
        
        aiBox.innerHTML = finalHtml;
        gameState.preAiAdvice = `[Algo=${stats.recommendQ}] ${reply}`;
        btn.disabled = false;
        btn.innerText = "ğŸ”„ é‡æ–°åˆ†æ";
    }

    async function submitDecision() {
        const orderInput = document.getElementById('order-quantity');
        const Q = parseInt(orderInput.value);
        if (isNaN(Q) || Q < 0) { alert("è¯·è¾“å…¥æœ‰æ•ˆçš„è®¢è´§é‡ï¼"); return; }
        
        const submitBtn = document.getElementById('btn-submit');
        submitBtn.disabled = true;
        submitBtn.innerText = "â³ ç»“ç®—ä¸­...";

        // 1. ç»“ç®—é€»è¾‘
        gameState.currentOrder = Q;
        gameState.currentTrueDemand = Math.floor(Math.random() * 301);
        gameState.currentSales = Math.min(Q, gameState.currentTrueDemand);
        gameState.currentProfit = (12 * gameState.currentSales) - (3 * Q);
        gameState.totalProfit += gameState.currentProfit;
        gameState.currentStockout = gameState.currentTrueDemand > Q; // è®°å½•æ˜¯å¦ç¼ºè´§

        // 2. å®æ—¶æ›´æ–°å†å²
        gameState.historyData.push({
            sales: gameState.currentSales,
            stockout: gameState.currentStockout
        });
        updateHistoryView();

        // 3. æ›´æ–°åé¦ˆé¡µ
        document.getElementById('fb-round-num').innerText = gameState.currentRound;
        document.getElementById('fb-order').innerText = Q;
        document.getElementById('fb-sales').innerText = gameState.currentSales;

        // --- æ ¸å¿ƒä¿®æ”¹ï¼šå¤„ç†çœŸå®éœ€æ±‚æ˜¾ç¤º ---
        const demandEl = document.getElementById('fb-demand');
        if (gameState.currentStockout) {
            // å¦‚æœç¼ºè´§ï¼Œéšè—çœŸå®éœ€æ±‚
            demandEl.innerText = "æœªçŸ¥ (å·²å”®ç½„)";
            demandEl.style.color = "#d35400"; // æ©™è‰²è­¦å‘Š
        } else {
            // å¦‚æœæ²¡ç¼ºè´§ï¼Œæ˜¾ç¤ºçœŸå®éœ€æ±‚
            demandEl.innerText = gameState.currentTrueDemand;
            demandEl.style.color = "#2c3e50"; // æ­£å¸¸é¢œè‰²
        }

        const profitSpan = document.getElementById('fb-profit');
        profitSpan.innerText = gameState.currentProfit;
        profitSpan.style.color = gameState.currentProfit >= 0 ? "#28a745" : "#c0392b";

        switchScreen('feedback-screen');
        await getPostFeedback();
        saveRoundData(); 
        document.querySelector('.btn-next').disabled = false;
    }

    async function getPostFeedback() {
        const aiBox = document.getElementById('post-ai-box');
        
        // --- æ ¸å¿ƒä¿®æ”¹ï¼šé’ˆå¯¹ç¼ºè´§æƒ…å†µè°ƒæ•´ Promptï¼Œé˜²æ­¢ AI æ³„å¯† ---
        let demandInfoForAI = "";
        let instruction = "";

        if (gameState.currentStockout) {
            // å¦‚æœç¼ºè´§ï¼Œå‘Šè¯‰AIçœŸå®å€¼ï¼Œä½†ä¸¥ä»¤ç¦æ­¢é€éœ²
            demandInfoForAI = `çœŸå®éœ€æ±‚ D=${gameState.currentTrueDemand} (æ³¨æ„ï¼šå› ä¸º D > Qï¼Œç”¨æˆ·ç•Œé¢æ˜¾ç¤ºä¸ºâ€œæœªçŸ¥/å”®ç½„â€)`;
            instruction = `æ³¨æ„ï¼šæœ¬è½®å‘ç”Ÿäº†ç¼ºè´§ï¼Œç”¨æˆ·ä¸çŸ¥é“çœŸå®éœ€æ±‚æ˜¯å¤šå°‘ã€‚è¯·ä¸è¦åœ¨å›å¤ä¸­é€éœ²å…·ä½“çš„ D å€¼ï¼åªå¼ºè°ƒå› å¤‡è´§ä¸è¶³å¯¼è‡´äº†æ½œåœ¨çš„åˆ©æ¶¦æŸå¤±ã€‚`;
        } else {
            demandInfoForAI = `çœŸå®éœ€æ±‚ D=${gameState.currentTrueDemand}`;
            instruction = `ç‚¹è¯„ç”¨æˆ·çš„åº“å­˜æ§åˆ¶æƒ…å†µã€‚`;
        }

        const prompt = `å›é¡¾è¿™è½®æŠ¥ç«¥å†³ç­–ã€‚p=12, c=3ã€‚
è¢«è¯•è®¢è´§é‡ Q=${gameState.currentOrder}ã€‚
${demandInfoForAI}ã€‚
æœ¬è½®åˆ©æ¶¦=${gameState.currentProfit}ã€‚
è¯·ç®€çŸ­ç‚¹è¯„ã€‚${instruction} 80å­—ä»¥å†…ã€‚`;

        const reply = await callDeepSeek(prompt);
        aiBox.innerHTML = marked.parse(reply);
        gameState.postAiAdvice = reply;
    }

    async function saveRoundData() {
        if (typeof window.supabase === 'undefined') return;
        const client = window.supabase.createClient(supabaseUrl, supabaseKey);
        await client.from('newsvendor_rounds').insert([{
            participant_id: gameState.participantId,
            round_num: gameState.currentRound,
            order_q: gameState.currentOrder,
            true_demand: gameState.currentTrueDemand,
            sales: gameState.currentSales,
            profit: gameState.currentProfit,
            ai_pre_advice: gameState.preAiAdvice,
            ai_post_feedback: gameState.postAiAdvice
        }]);
    }

    function nextRound() {
        if (gameState.currentRound >= gameState.maxRounds) {
            document.getElementById('total-profit-span').innerText = gameState.totalProfit;
            switchScreen('final-screen');
        } else {
            gameState.currentRound++;
            updateRoundDisplay(); 
            
            document.getElementById('order-quantity').value = '';
            document.getElementById('pre-ai-box').classList.add('hidden');
            document.getElementById('btn-pre-ai').disabled = false;
            document.getElementById('btn-pre-ai').innerText = "ğŸ§  å¯åŠ¨ç®—æ³•åˆ†æä¸ AI å»ºè®®";
            document.getElementById('btn-submit').disabled = false;
            document.getElementById('btn-submit').innerText = "âœ… ç¡®è®¤è®¢è´§å¹¶æäº¤";
            document.getElementById('post-ai-box').innerHTML = '<span class="loading">â³ DeepSeek æ­£åœ¨å¤ç›˜...</span>';
            document.querySelector('.btn-next').disabled = true;
            gameState.preAiAdvice = "";
            gameState.postAiAdvice = "";
            
            switchScreen('game-screen');
        }
    }

    async function callDeepSeek(promptText) {
        try {
            const response = await fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + deepSeekKey },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{"role": "user", "content": promptText}],
                    temperature: 1.0
                })
            });
            const data = await response.json();
            return data.choices && data.choices.length > 0 ? data.choices[0].message.content : "AI æš‚æ—¶æ— å“åº”";
        } catch (e) { console.error(e); return "AI è¿æ¥å¤±è´¥"; }
    }

    function updateHistoryView() {
        const list = document.getElementById('history-list');
        list.innerHTML = ''; 
        const recentData = gameState.historyData.slice().reverse().slice(0, 40);
        const totalHistory = gameState.historyData.length;

        recentData.forEach((item, index) => {
            const li = document.createElement('li');
            const realIndex = totalHistory - index; 
            const isExperimentRound = realIndex > 40; 
            
            let labelTag = '';
            if (isExperimentRound) {
                labelTag = `<span style="background:#2ecc71; color:white; padding:1px 4px; border-radius:3px; font-size:11px; margin-right:4px;">R${realIndex-40}</span>`;
            } else {
                labelTag = `<span style="background:#95a5a6; color:white; padding:1px 4px; border-radius:3px; font-size:11px; margin-right:4px;">Hist</span>`;
            }

            li.innerHTML = `
                <div>${labelTag} é”€é‡: <strong>${item.sales}</strong></div>
                ${item.stockout ? '<span class="sold-out">å”®ç½„</span>' : ''}
            `;
            if (isExperimentRound && realIndex === totalHistory) {
                li.style.backgroundColor = "#ffffcc";
            }
            list.appendChild(li);
        });
    }

    function updateRoundDisplay() { document.getElementById('current-round-span').innerText = gameState.currentRound; }
    function switchScreen(id) {
        ['setup-screen', 'game-screen', 'feedback-screen', 'final-screen'].forEach(sid => document.getElementById(sid).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
</script>
</body>
</html>